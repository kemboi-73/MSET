{% extends "posApp/base.html" %}
{% block pageContent %}
{% load humanize %}
<link href="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">

<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card">
        <div class="d-flex justify-content-between">
            <h4 class="card-title mb-0">Analytics Overview</h4>
        </div>
    </div>
</div>

<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <hr class="w-100">
</div>

<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-3-desktop mdc-layout-grid__cell--span-3-tablet">
    <div class="mdc-card info-card info-card--success">
        <div class="card-inner">
            <h5 class="card-title">Categories</h5>
            <h5 class="font-weight-light pb-2 mb-1 border-bottom">{{ categories|intcomma }}</h5>
            <p class="tx-12 text-muted">Over All Count of Categories</p>
            <div class="card-icon-wrapper">
                <i class="material-icons">list</i>
            </div>
        </div>
    </div>
</div>

<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-3-desktop mdc-layout-grid__cell--span-3-tablet">
    <div class="mdc-card info-card info-card--primary">
        <div class="card-inner">
            <h5 class="card-title">Products</h5>
            <h5 class="font-weight-light pb-2 mb-1 border-bottom">{{ products|intcomma }}</h5>
            <p class="tx-12 text-muted">Over All Count of Products</p>
            <div class="card-icon-wrapper">
                <i class="material-icons">label</i>
            </div>
        </div>
    </div>
</div>

<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-3-desktop mdc-layout-grid__cell--span-3-tablet">
    <div class="mdc-card info-card info-card--info">
        <div class="card-inner">
            <h5 class="card-title">Today's Transactions</h5>
            <h5 class="font-weight-light pb-2 mb-1 border-bottom">{{ transaction|intcomma }}</h5>
            <p class="tx-12 text-muted">Over All Count of Today's Transactions</p>
            <div class="card-icon-wrapper">
                <i class="material-icons">receipt</i>
            </div>
        </div>
    </div>
</div>

<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-3-desktop mdc-layout-grid__cell--span-3-tablet">
    <div class="mdc-card info-card info-card--warning">
        <div class="card-inner">
            <h5 class="card-title">Today's Sales</h5>
            <h5 class="font-weight-light pb-2 mb-1 border-bottom">{{ total_sales|intcomma }}</h5>
            <p class="tx-12 text-muted">Total Sales Today</p>
            <div class="card-icon-wrapper">
                <i class="mdi mdi-cash-multiple"></i>
            </div>
        </div>
    </div>
</div>

<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#lowQuantityCollapse" aria-expanded="false" aria-controls="lowQuantityCollapse">
        View Low Quantity Products
    </button>
    <div class="collapse" id="lowQuantityCollapse">
        <div class="card card-body mt-3">
            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Code</th>
                            <th>Name</th>
                            <th>Quantity</th>
                            <th>Threshold</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in low_quantity_products %}
                        <tr>
                            <td>{{ product.id }}</td>
                            <td>{{ product.code }}</td>
                            <td>{{ product.name }}</td>
                            <td>{{ product.quantity }}</td>
                            <td>{{ product.low_quantity_threshold }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center">No low quantity products</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Most Sold Products Graph -->
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-112">
    <div class="mdc-card">
        <div class="d-flex justify-content-between">
            <h4 class="card-title mb-0">Most Sold Products</h4>
        </div>
        <div class="chart-container">
            <canvas id="mostSoldProductsChart"></canvas>
        </div>
    </div>
</div>
<!-- Most Sold Products in the Past Month Chart -->
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-112">
    <div class="mdc-card">
        <div class="d-flex justify-content-between">
            <h4 class="card-title mb-0">Most Sold Products in the Past Month</h4>
        </div>
        <div class="chart-container">
            <canvas id="mostSoldProductsMonthChart"></canvas>
        </div>
    </div>
</div>

<!-- Sales in Last 7 Days Chart -->
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-112">
    <div class="mdc-card">
        <div class="d-flex justify-content-between">
            <h4 class="card-title mb-0">Sales in Last 7 Days</h4>
        </div>
        <div class="chart-container">
            <canvas id="salesLast7DaysChart"></canvas>
        </div>
    </div>
</div>
<!-- Sales in Last 6 Months Chart -->
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-112">
    <div class="mdc-card">
        <div class="d-flex justify-content-between">
            <h4 class="card-title mb-0">Sales in Last 6 Months</h4>
        </div>
        <div class="chart-container">
            <canvas id="salesLast6MonthsChart"></canvas>
        </div>
    </div>
</div>


{% endblock %}

{% block ScriptBlock %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Most Sold Products Chart
    const ctxMostSold = document.getElementById('mostSoldProductsChart').getContext('2d');
    const mostSoldProductsChart = new Chart(ctxMostSold, {
        type: 'pie',
        data: {
            labels: [{% for product in most_sold_products %}'{{ product.product_id__name }}',{% endfor %}],
            datasets: [{
                data: [{% for product in most_sold_products %}{{ product.total_sold }},{% endfor %}],
                backgroundColor: [
                    'rgba(25, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 206, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)'
                ],
                borderColor: [
                    'rgba(25, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(tooltipItem) {
                            return tooltipItem.label + ': ' + tooltipItem.raw;
                        }
                    }
                }
            }
        }
    });

    // Sales Last 7 Days Chart
    const ctxSales7Days = document.getElementById('salesLast7DaysChart').getContext('2d');
    const salesLast7DaysChart = new Chart(ctxSales7Days, {
        type: 'line',
        data: {
            labels: [{% for day in sales_last_7_days %}'{{ day.date }}',{% endfor %}],
            datasets: [{
                label: 'Sales',
                data: [{% for day in sales_last_7_days %}{{ day.total_sales }},{% endfor %}],
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(tooltipItem) {
                            return tooltipItem.label + ': ' + tooltipItem.raw;
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Sales Amount'
                    }
                }
            }
        }
    });
    // Sales Last 6 Months Chart
    const ctxSales6Months = document.getElementById('salesLast6MonthsChart').getContext('2d');
    const salesLast6MonthsChart = new Chart(ctxSales6Months, {
        type: 'bar',
        data: {
            labels: [{% for month in sales_last_6_months %}'{{ month.month }}',{% endfor %}],
            datasets: [{
                label: 'Sales',
                data: [{% for month in sales_last_6_months %}{{ month.total_sales }},{% endfor %}],
                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                borderColor: 'rgba(153, 102, 255, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(tooltipItem) {
                            return tooltipItem.label + ': ' + tooltipItem.raw;
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Month'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Sales Amount'
                    }
                }
            }
        }
    });

    const ctxMostSoldProductsMonth = document.getElementById('mostSoldProductsMonthChart').getContext('2d');
    const mostSoldProductsMonthChart = new Chart(ctxMostSoldProductsMonth, {
        type: 'doughnut',
        data: {
            labels: [{% for product in most_sold_products_month %}'{{ product.product_id__name }}',{% endfor %}],
            datasets: [{
                label: 'Sold Quantity',
                data: [{% for product in most_sold_products_month %}{{ product.total_sold }},{% endfor %}],
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 206, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(tooltipItem) {
                            return tooltipItem.label + ': ' + tooltipItem.raw;
                        }
                    }
                }
            }
        }
    });
</script>

{% endblock %}

{% block styles %}
<style>
    .modal-dialog {
        max-width: 90vw; /* Make modal width responsive */
    }
    .chart-container {
        position: relative;
        height: 30vw; /* Responsive height */
        max-height: 400px; /* Max height to prevent it from being too large */
        width: 30vw; /* Responsive width */
        max-width: 400px; /* Max width to prevent it from being too large */
        margin: auto;
    }
    .table-sm th, .table-sm td {
        padding: 0.3rem;
    }
</style>
{% endblock %}